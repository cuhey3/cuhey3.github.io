<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <title></title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th, td {
            padding: 5px;
        }
    </style>
</head>
<body>
<h2>WebRTCチャット</h2>
<label>
    <input type="radio" name="join-type" value="host"/>ホスト
</label>
<label>
    <input type="radio" name="join-type" value="guest"/>ゲスト
</label>
<label>
</label>
<div>
    <label>
        チャットルームトークン
        <textarea id="offer-token-input" disabled></textarea>
    </label>
    <input type="button" id="offer-token-button" value="コピーする" disabled/>
</div>
<div>
    <label>
        チャットルーム参加トークン
        <textarea id="answer-token-input" disabled></textarea>
    </label>
    <input type="button" id="answer-token-button" value="読み込む" disabled/>
</div>
<div>
    <label>
        メッセージ
        <textarea id="message-input"></textarea>
    </label>
    <input type="button" id="message-send-button" value="送信"/>
</div>
<h3>チャット</h3>
<table>
    <thead>
    <tr>
        <th>time</th>
        <th>user</th>
        <th>comment</th>
    </tr>
    </thead>
    <tbody id="chat-messages-tbody">
    </tbody>
</table>
<script>
    const offerTokenButton = document.querySelector('#offer-token-button');
    const offerTokenInput = document.querySelector('#offer-token-input');
    const answerTokenButton = document.querySelector('#answer-token-button');
    const answerTokenInput = document.querySelector('#answer-token-input');
    const messageInput = document.querySelector('#message-input');
    const messageSendButton = document.querySelector('#message-send-button');
    const chatMessagesTbody = document.querySelector('#chat-messages-tbody');
    const CONFIG_FOR_SENDER = {
        iceServers: [
            {
                urls: "stun:stun.l.google.com:19302",
            },
        ],
    };

    const hostConnection = new RTCPeerConnection(CONFIG_FOR_SENDER);
    const guestConnection = new RTCPeerConnection(CONFIG_FOR_SENDER);

    hostConnection.onicecandidate = function(event) {
        console.log('host ice', event);
        const offerTokenWithICE = JSON.parse(offerToken);
        offerTokenWithICE.ice.push(event.candidate);
        offerToken = JSON.stringify(offerTokenWithICE);
        offerTokenInput.value = offerToken;
    }

    hostSendChannel = hostConnection.createDataChannel('sendDataChannel');
    hostConnection.ondatachannel = function(event) {
        event.channel.onopen = function() {
            console.log('host send onopen');
            messageSendButton.onclick = function () {
                console.log('send message', messageInput.value);
                (async function() {
                    // なんでこの書き方をしないといけない？？？
                    await hostSendChannel.send(messageInput.value);
                    addMessageToTable('host', messageInput.value);
                })();
            };
            (async function() {
                // なんでこの書き方をしないといけない？？？
                await hostSendChannel.send('joined.');
                addMessageToTable('host', 'joined.');
            })();
        }

        event.channel.onmessage = function(event) {
            console.log('from guest message', event);
            addMessageToTable('guest', event.data);
        }

        event.channel.onerror = function(event) {
            console.log('host send error', event);
        }

    }

    // ICE取得処理が重複してるのはおかしい
    guestConnection.onicecandidate = function(event) {
        console.log('guest ice', event);
        const answerTokenWithICE = JSON.parse(answerTokenInput.value);
        answerTokenWithICE.ice.push(event.candidate);
        answerToken = JSON.stringify(answerTokenWithICE);
        answerTokenInput.value = answerToken;
    }

    guestSendChannel = guestConnection.createDataChannel('sendDataChannel');
    guestConnection.ondatachannel = function(event) {
        event.channel.onopen = function() {
            console.log('guest send onopen', event);
            event.channel.send('i am guest');
            messageSendButton.onclick = function() {
                console.log('send message', messageInput.value);
                (async function() {
                    // なんでこの書き方をしないといけない？？？
                    await guestSendChannel.send(messageInput.value);
                    addMessageToTable('guest', messageInput.value);
                })();
            };
            (async function() {
                // なんでこの書き方をしないといけない？？？
                await guestSendChannel.send('joined.');
                addMessageToTable('guest', 'joined.');
            })();

        }

        event.channel.onmessage = function(event) {
            console.log('from host message', event);
            addMessageToTable('host', event.data);
        }
        event.channel.onerror = function(event) {
            console.log('guest send error', event);
        }
    }
    let offerToken = '';
    let answerToken = '';
    function setOfferToken() {
        if (offerToken) {
            offerTokenInput.value = offerToken;
        } else {
            (async function () {
                await (async () => {
                    const offer = await hostConnection.createOffer();
                    await hostConnection.setLocalDescription(offer);
                    offer.ice = [];
                    offerToken = JSON.stringify(offer);
                    console.log(`offerToken created. ${offerToken}`);
                    offerTokenInput.value = offerToken;
                })();
            })();
        }
    }
    function setAnswerToken() {
        (async function () {
            await (async () => {
                const offerTokenWithICE = JSON.parse(offerTokenInput.value);
                await guestConnection.setRemoteDescription(JSON.parse(offerTokenInput.value));
                const answer = await guestConnection.createAnswer();
                answer.ice = [];
                answerToken = JSON.stringify(answer);
                console.log(`answerToken created. ${answerToken}`);
                await guestConnection.setLocalDescription(answer);
                answerTokenInput.value = answerToken;
                for (let i = 0; i < offerTokenWithICE.ice.length; i++) {
                    if (offerTokenWithICE.ice[i]) {
                        await guestConnection.addIceCandidate(new RTCIceCandidate(offerTokenWithICE.ice[i]));
                    }
                }
            })();
        })();
    }

    function loadAnswerToken() {
        (async function () {
            await (async () => {
                answerToken = answerTokenInput.value;
                const answerTokenWithICE = JSON.parse(answerToken);
                await hostConnection.setRemoteDescription(answerTokenWithICE);
                for (let i = 0; i < answerTokenWithICE.ice.length; i++) {
                    if (answerTokenWithICE.ice[i]) {
                        await hostConnection.addIceCandidate(new RTCIceCandidate(answerTokenWithICE.ice[i]));
                    }
                }
            })();
        })();
    }

    const candidates = [];

    function enableOfferTokenInput(isEnable) {
        if (isEnable) {
            if (offerTokenInput.value) {
                offerTokenInput.value = '';
            }
            offerTokenButton.value = '読み込む';
            offerTokenButton.onclick = setAnswerToken;
            offerTokenButton.disabled = '';
            offerTokenInput.disabled = '';
            offerTokenInput.placeholder = 'トークンを貼り付ける';
        } else {
            setOfferToken();
            offerTokenButton.value = 'コピーする';
            offerTokenButton.onclick = function() {
                (async function() {
                    await navigator.clipboard.writeText(offerTokenInput.value);
                })();
            };
            offerTokenInput.disabled = 'disabled';
            offerTokenButton.disabled = '';
            offerTokenInput.placeholder = '';
        }
    }

    function enableAnswerTokenInput(isEnable) {
        if (isEnable) {
            answerTokenButton.value = '読み込む';
            answerTokenButton.onclick = loadAnswerToken;
            answerTokenInput.disabled = '';
            answerTokenButton.disabled = '';
            answerTokenInput.placeholder = '参加トークンを貼り付ける';
        } else {
            answerTokenButton.value = 'コピーする';
            answerTokenButton.onclick = function() {
                (async function() {
                    await navigator.clipboard.writeText(answerTokenInput.value);
                })();
            };
            answerTokenButton.disabled = '';
            answerTokenInput.placeholder = '';
        }
    }

    function addMessageToTable(userName, message) {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.innerText = new Date().toLocaleString();
        tr.appendChild(td1);
        const td2 = document.createElement('td');
        td2.innerText = userName;
        tr.appendChild(td2);
        const td3 = document.createElement('td');
        td3.innerText = message;
        tr.appendChild(td3);
        chatMessagesTbody.appendChild(tr);
    }

    Array.from(document.querySelectorAll('[name=join-type]')).forEach((element) => {
        element.onchange = (event) => {
            const isHost = event.target.value === 'host';
            if (isHost) {
                enableOfferTokenInput(false);
                enableAnswerTokenInput(true);
            } else {
                enableOfferTokenInput(true);
                enableAnswerTokenInput(false);
            }
        }
    });
</script>
</body>
</html>