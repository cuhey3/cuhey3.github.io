<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <title></title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th, td {
            padding: 5px;
        }
    </style>
</head>
<body>
<h2>WebRTCチャット</h2>
<label>
    <input type="radio" name="join-type" value="host"/>ホスト
</label>
<label>
    <input type="radio" name="join-type" value="guest"/>ゲスト
</label>
<div>
    <label>
        参加リクエストトークン
        <textarea id="offer-token-input" disabled></textarea>
    </label>
    <input type="button" id="offer-token-button" value="コピーする" disabled/>
</div>
<div>
    <label>
        参加許可トークン
        <textarea id="answer-token-input" disabled></textarea>
    </label>
    <input type="button" id="answer-token-button" value="読み込む" disabled/>
</div>
<div>
    <label>
        メッセージ
        <textarea id="message-input"></textarea>
    </label>
    <input type="button" id="message-send-button" value="送信"/>
</div>
<h3>チャット</h3>
<table>
    <thead>
    <tr>
        <th>time</th>
        <th>user</th>
        <th>comment</th>
    </tr>
    </thead>
    <tbody id="chat-messages-tbody">
    </tbody>
</table>
<script>
    class Message {
        static JOINED_MESSAGE = 'joined';
        static CREATE_SPARE_OFFER_MESSAGE = 'create_spare_offer';
        static SPARE_OFFER_MESSAGE = 'spare_offer';
        static CREATE_SPARE_ANSWER_MESSAGE = 'create_spare_answer';
        static SPARE_ANSWER_MESSAGE = 'spare_answer';

        constructor(body, userName, messageType) {
            this.userName = userName;
            this.messageType = messageType;
            this.body = body;
        }

        static fromJson(str) {
            const {userName, messageType, body} = JSON.parse(str);
            return new Message(body, userName, messageType);
        }

        static toJson(messageObj) {
            const {userName, messageType, body} = messageObj;
            return JSON.stringify({body, userName, messageType});
        }

        getBody() {
            return this.body;
        }

        isJoined() {
            return this.messageType === Message.JOINED_MESSAGE;
        }

        isCreateSpareOffer() {
            return this.messageType === Message.CREATE_SPARE_OFFER_MESSAGE;
        }

        isSpareOffer() {
            return this.messageType === Message.SPARE_OFFER_MESSAGE;
        }

        isCreateSpareAnswer() {
            return this.messageType === Message.CREATE_SPARE_ANSWER_MESSAGE;
        }

        isSpareAnswer() {
            return this.messageType === Message.SPARE_ANSWER_MESSAGE;
        }
    }

    const offerTokenButton = document.querySelector('#offer-token-button');
    const offerTokenInput = document.querySelector('#offer-token-input');
    const answerTokenButton = document.querySelector('#answer-token-button');
    const answerTokenInput = document.querySelector('#answer-token-input');
    const messageInput = document.querySelector('#message-input');
    const messageSendButton = document.querySelector('#message-send-button');
    const chatMessagesTbody = document.querySelector('#chat-messages-tbody');
    const CONFIG_FOR_SENDER = {
        iceServers: [
            {
                urls: "stun:stun.l.google.com:19302",
            },
        ],
    };

    const connections = [];
    let offerToken;
    const answerTokens = [];
    const guestSendChannels = [];
    const hostSendChannels = [];
    const JOINED_MESSAGE = 'joined.';
    let spareAnswerToken = '';

    async function addOfferedConnection(index) {
        connections[index] = new RTCPeerConnection(CONFIG_FOR_SENDER);
        connections[index].onicecandidate = function (event) {
            console.log('guest ice', event);
            const offerTokenWithICE = JSON.parse(offerToken);
            if (event.candidate) {
                offerTokenWithICE.ice.push(event.candidate);
                offerToken = JSON.stringify(offerTokenWithICE);
                offerTokenInput.value = offerToken;
            } else if (index > 0) {
                (async function () {
                    await guestSendChannels[0].send(Message.toJson({
                        messageType: Message.SPARE_OFFER_MESSAGE,
                        body: offerToken
                    }));
                })();
            }
        }

        guestSendChannels[index] = connections[index].createDataChannel('sendDataChannel');
        connections[index].ondatachannel = function (event) {
            event.channel.onopen = function () {
                console.log('guest send onopen', event);
                messageSendButton.onclick = function () {
                    console.log('send message', messageInput.value);
                    (async function () {
                        await guestSendChannels[index].send(Message.toJson({body: messageInput.value}));
                    })();
                };
                (async function () {
                    await guestSendChannels[index].send(Message.toJson({
                        messageType: Message.JOINED_MESSAGE,
                        body: 'joined.'
                    }));
                })();
            }

            event.channel.onmessage = function (event) {
                console.log('from host message', event);
                const message = Message.fromJson(event.data);
                if (message.isCreateSpareOffer()) {
                    (async function () {
                        console.log('create spare offer logic start');
                        await addOfferedConnection(connections.length);
                        console.log('create spare offer logic end');
                    })();
                }
                else if (message.isSpareAnswer()) {
                    console.log('get spare answer', message.body);
                    spareAnswerToken = message.body;
                    return;
                }
                else if (message.isCreateSpareAnswer()) {
                    console.log('get spare offer', message.body);
                    console.log('create spare answer logic start');
                    offerTokenInput.value = message.body;
                    setAnswerToken();
                    console.log('create spare answer logic end');
                    return;
                }
                addMessageToTable(message.userName, message.body);
            }
            event.channel.onclose = function (event) {
                if (index === 0 && spareAnswerToken) {
                    answerTokenInput.value = spareAnswerToken;
                    spareAnswerToken = '';
                    loadAnswerToken();
                }
            }
            event.channel.onerror = function (event) {
                console.log('guest send error', event);
            }
        }
        const offer = await connections[index].createOffer();
        await connections[index].setLocalDescription(offer);
        offer.ice = [];
        offerToken = JSON.stringify(offer);
        console.log(`offerToken created. ${offerToken}`);
        offerTokenInput.value = offerToken;
    }

    function addAnsweredConnection(index) {
        // ICE取得処理が重複してるのはおかしい
        connections[index].onicecandidate = function (event) {
            console.log('host ice', event);
            const answerTokenWithICE = JSON.parse(answerTokenInput.value);
            if (event.candidate) {
            answerTokenWithICE.ice.push(event.candidate);
            answerTokens[index] = JSON.stringify(answerTokenWithICE);
                answerTokenInput.value = answerTokens[index];
            } else if (guestSendChannels.length > 0) {
                (async function () {
                    await guestSendChannels[0].send(Message.toJson({
                        messageType: Message.SPARE_ANSWER_MESSAGE,
                        body: answerTokens[index]
                    }));
                })();
            }
        }

        hostSendChannels[index] = connections[index].createDataChannel('sendDataChannel');
        connections[index].ondatachannel = function (event) {
            event.channel.onopen = function () {
                console.log('host send onopen');
                messageSendButton.onclick = function () {
                    console.log('send message', messageInput.value);
                    (async function () {
                        for (let i = 0; i < hostSendChannels.length; i++) {
                            await hostSendChannels[i].send(Message.toJson({
                                userName: 'host',
                                body: messageInput.value
                            }));
                        }
                        addMessageToTable('host', messageInput.value);
                    })();
                };
                (async function () {
                    await hostSendChannels[index].send(JSON.stringify({
                        userName: 'host',
                        messageType: JOINED_MESSAGE,
                        body: 'joined.'
                    }));
                    addMessageToTable('host', Message.JOINED_MESSAGE);
                })();
            }

            event.channel.onmessage = function (event) {
                console.log('from guest message', event);
                const message = Message.fromJson(event.data);
                addMessageToTable(`guest${index + 1}`, message.body);
                // ゲスト二人目以降はスペアのoffer作成リクエストを送信する
                if (message.isJoined() && index > 0) {
                    (async function () {
                        await hostSendChannels[index].send(Message.toJson({
                            userName: 'host',
                            messageType: Message.CREATE_SPARE_OFFER_MESSAGE,
                            body: Message.CREATE_SPARE_OFFER_MESSAGE
                        }));
                        addMessageToTable('host', Message.CREATE_SPARE_OFFER_MESSAGE);
                    })();
                } else if (message.isSpareOffer()) {
                    (async function(){
                        await hostSendChannels[0].send(Message.toJson({
                            userName: 'host',
                            messageType: Message.CREATE_SPARE_ANSWER_MESSAGE,
                            body: message.body
                        }));
                    })();
                    return;
                } else if (message.isSpareAnswer()) {
                    (async function(){
                        //
                        await hostSendChannels[hostSendChannels.length - 1].send(Message.toJson({
                            userName: 'host',
                            messageType: Message.SPARE_ANSWER_MESSAGE,
                            body: message.body
                        }));
                    })();
                    return;
                }
                (async function () {
                    for (let i = 0; i < hostSendChannels.length; i++) {
                        await hostSendChannels[i].send(Message.toJson({
                            userName: `guest${index + 1}`,
                            body: message.body,
                        }));
                    }
                })();
            }
            event.channel.onerror = function (event) {
                console.log('guest send error', event);
            }
        }
    }

    function setOfferToken() {
        if (offerToken) {
            offerTokenInput.value = offerToken;
        } else {
            (async function () {
                const index = connections.length;
                await addOfferedConnection(index);
            })();
        }
    }

    function setAnswerToken() {
        connections.push(new RTCPeerConnection(CONFIG_FOR_SENDER));
        const guestIndex = connections.length - 1;
        addAnsweredConnection(guestIndex);
        (async function () {
            await (async () => {
                const offerTokenWithICE = JSON.parse(offerTokenInput.value);
                await connections[guestIndex].setRemoteDescription(JSON.parse(offerTokenInput.value));
                const answer = await connections[guestIndex].createAnswer();
                answer.ice = [];
                answerTokens[guestIndex] = JSON.stringify(answer);
                console.log(`answerToken created. ${answerTokens[guestIndex]}`);
                await connections[guestIndex].setLocalDescription(answer);
                answerTokenInput.value = answerTokens[guestIndex];
                for (let i = 0; i < offerTokenWithICE.ice.length; i++) {
                    if (offerTokenWithICE.ice[i]) {
                        await connections[guestIndex].addIceCandidate(new RTCIceCandidate(offerTokenWithICE.ice[i]));
                    }
                }
            })();
        })();
    }

    function loadAnswerToken() {
        (async function () {
            await (async () => {
                const guestIndex = connections.length - 1;
                answerTokens[guestIndex] = answerTokenInput.value;
                const answerTokenWithICE = JSON.parse(answerTokens[guestIndex]);
                await connections[guestIndex].setRemoteDescription(answerTokenWithICE);
                for (let i = 0; i < answerTokenWithICE.ice.length; i++) {
                    if (answerTokenWithICE.ice[i]) {
                        await connections[guestIndex].addIceCandidate(new RTCIceCandidate(answerTokenWithICE.ice[i]));
                    }
                }
            })();
        })();
    }

    function enableOfferTokenInput(isEnable) {
        if (isEnable) {
            if (offerTokenInput.value) {
                offerTokenInput.value = '';
            }
            offerTokenButton.value = '読み込む';
            offerTokenButton.onclick = setAnswerToken;
            offerTokenButton.disabled = '';
            offerTokenInput.disabled = '';
            offerTokenInput.placeholder = '参加リクエストトークンを貼り付ける';
        } else {
            setOfferToken();
            offerTokenButton.value = 'コピーする';
            offerTokenButton.onclick = function () {
                (async function () {
                    await navigator.clipboard.writeText(offerTokenInput.value);
                })();
            };
            offerTokenInput.disabled = 'disabled';
            offerTokenButton.disabled = '';
            offerTokenInput.placeholder = '';
        }
    }

    function enableAnswerTokenInput(isEnable) {
        if (isEnable) {
            answerTokenButton.value = '読み込む';
            answerTokenButton.onclick = loadAnswerToken;
            answerTokenInput.disabled = '';
            answerTokenButton.disabled = '';
            answerTokenInput.placeholder = '参加許可トークンを貼り付ける';
        } else {
            answerTokenButton.value = 'コピーする';
            answerTokenButton.onclick = function () {
                (async function () {
                    await navigator.clipboard.writeText(answerTokenInput.value);
                })();
            };
            answerTokenButton.disabled = '';
            answerTokenInput.placeholder = '';
        }
    }

    function addMessageToTable(userName, message) {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.innerText = new Date().toLocaleString();
        tr.appendChild(td1);
        const td2 = document.createElement('td');
        td2.innerText = userName;
        tr.appendChild(td2);
        const td3 = document.createElement('td');
        td3.innerText = message;
        tr.appendChild(td3);
        chatMessagesTbody.appendChild(tr);
    }

    Array.from(document.querySelectorAll('[name=join-type]')).forEach((element) => {
        element.onchange = (event) => {
            const isGuest = event.target.value === 'guest';
            if (isGuest) {
                enableOfferTokenInput(false);
                enableAnswerTokenInput(true);
            } else {
                enableOfferTokenInput(true);
                enableAnswerTokenInput(false);
            }
        }
    });
</script>
</body>
</html>