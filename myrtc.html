<html lang="ja">
<head>
    <meta charset="utf-8"/>
    <title></title>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th, td {
            padding: 5px;
        }
    </style>
</head>
<body>
<h2>WebRTCチャット</h2>
<label>
    <input type="radio" name="join-type" value="host"/>ホスト
</label>
<label>
    <input type="radio" name="join-type" value="guest"/>ゲスト
</label>
<div>
<label for="guest-select">ゲストは何人目?</label>
<select name="guests" id="guest-select">
    <option value="0">1人目</option>
    <option value="1">2人目</option>
</select>
</div>
<div>
    <label>
        チャットルームトークン
        <textarea id="offer-token-input" disabled></textarea>
    </label>
    <input type="button" id="offer-token-button" value="コピーする" disabled/>
</div>
<div>
    <label>
        チャットルーム参加トークン
        <textarea id="answer-token-input" disabled></textarea>
    </label>
    <input type="button" id="answer-token-button" value="読み込む" disabled/>
</div>
<div>
    <label>
        メッセージ
        <textarea id="message-input"></textarea>
    </label>
    <input type="button" id="message-send-button" value="送信"/>
</div>
<h3>チャット</h3>
<table>
    <thead>
    <tr>
        <th>time</th>
        <th>user</th>
        <th>comment</th>
    </tr>
    </thead>
    <tbody id="chat-messages-tbody">
    </tbody>
</table>
<script>
    const offerTokenButton = document.querySelector('#offer-token-button');
    const offerTokenInput = document.querySelector('#offer-token-input');
    const answerTokenButton = document.querySelector('#answer-token-button');
    const answerTokenInput = document.querySelector('#answer-token-input');
    const messageInput = document.querySelector('#message-input');
    const messageSendButton = document.querySelector('#message-send-button');
    const chatMessagesTbody = document.querySelector('#chat-messages-tbody');
    const guestSelect = document.querySelector('#guest-select');
    const CONFIG_FOR_SENDER = {
        iceServers: [
            {
                urls: "stun:stun.l.google.com:19302",
            },
        ],
    };

    const connections = [new RTCPeerConnection(CONFIG_FOR_SENDER), new RTCPeerConnection(CONFIG_FOR_SENDER)];
    const offerTokens = [];
    const answerTokens = [];
    const hostSendChannels = [];

    function addOfferedConnection(index) {
        connections[index].onicecandidate = function (event) {
            console.log('host ice', event);
            const offerTokenWithICE = JSON.parse(offerTokens[index]);
            offerTokenWithICE.ice.push(event.candidate);
            offerTokens[index] = JSON.stringify(offerTokenWithICE);
            offerTokenInput.value = offerTokens[index];
        }

        hostSendChannels[index] = connections[index].createDataChannel('sendDataChannel');
        connections[index].ondatachannel = function (event) {
            event.channel.onopen = function () {
                console.log('host send onopen');
                messageSendButton.onclick = function () {
                    console.log('send message', messageInput.value);
                    (async function () {
                        for (let i = 0; i < hostSendChannels.length; i++) {
                            await hostSendChannels[i].send(JSON.stringify({userName: 'host', data: messageInput.value}));
                        }
                        addMessageToTable('host', messageInput.value);
                    })();
                };
                (async function () {
                    // なんでこの書き方をしないといけない？？？
                    await hostSendChannels[index].send(JSON.stringify({userName: 'host', data: 'joined.'}));
                    addMessageToTable('host', 'joined.');
                })();
            }

            event.channel.onmessage = function (event) {
                console.log('from guest message', event);
                addMessageToTable(`guest${index + 1}`, event.data);
                (async function() {
                    for (let i = 0; i < hostSendChannels.length; i++) {
                        await hostSendChannels[i].send(JSON.stringify({userName: `guest${index + 1}`, data: event.data}));
                    }
                })();
            }

            event.channel.onerror = function (event) {
                console.log('host send error', event);
            }

        }
    }

    function addAnsweredConnection(index) {
        // ICE取得処理が重複してるのはおかしい
        connections[index].onicecandidate = function (event) {
            console.log('guest ice', event);
            const answerTokenWithICE = JSON.parse(answerTokenInput.value);
            answerTokenWithICE.ice.push(event.candidate);
            answerTokens[index] = JSON.stringify(answerTokenWithICE);
            answerTokenInput.value = answerTokens[index];
        }

        const guestSendChannel = connections[index].createDataChannel('sendDataChannel');
        connections[index].ondatachannel = function (event) {
            event.channel.onopen = function () {
                console.log('guest send onopen', event);
                event.channel.send('i am guest');
                messageSendButton.onclick = function () {
                    console.log('send message', messageInput.value);
                    (async function () {
                        // なんでこの書き方をしないといけない？？？
                        await guestSendChannel.send(messageInput.value);
                    })();
                };
                (async function () {
                    // なんでこの書き方をしないといけない？？？
                    await guestSendChannel.send('joined.');
                })();
            }

            event.channel.onmessage = function (event) {
                console.log('from host message', event);
                const message = JSON.parse(event.data);
                addMessageToTable(message.userName, message.data);
            }
            event.channel.onerror = function (event) {
                console.log('guest send error', event);
            }
        }
    }

    function setOfferToken() {
        const guestIndex = Number(guestSelect.value);
        if (offerTokens[guestIndex]) {
            offerTokenInput.value = offerTokens[guestIndex];
        } else {
            addOfferedConnection(guestIndex);
            (async function () {
                await (async () => {
                    const offer = await connections[guestIndex].createOffer();
                    await connections[guestIndex].setLocalDescription(offer);
                    offer.ice = [];
                    offerTokens[guestIndex] = JSON.stringify(offer);
                    console.log(`offerToken created. ${offerTokens[guestIndex]}`);
                    offerTokenInput.value = offerTokens[guestIndex];
                })();
            })();
        }
    }

    function setAnswerToken() {
        const guestIndex = Number(guestSelect.value);
        addAnsweredConnection(guestIndex);
        (async function () {
            await (async () => {
                const offerTokenWithICE = JSON.parse(offerTokenInput.value);
                await connections[guestIndex].setRemoteDescription(JSON.parse(offerTokenInput.value));
                const answer = await connections[guestIndex].createAnswer();
                answer.ice = [];
                answerTokens[guestIndex] = JSON.stringify(answer);
                console.log(`answerToken created. ${answerTokens[guestIndex]}`);
                await connections[guestIndex].setLocalDescription(answer);
                answerTokenInput.value = answerTokens[guestIndex];
                for (let i = 0; i < offerTokenWithICE.ice.length; i++) {
                    if (offerTokenWithICE.ice[i]) {
                        await connections[guestIndex].addIceCandidate(new RTCIceCandidate(offerTokenWithICE.ice[i]));
                    }
                }
            })();
        })();
    }

    function loadAnswerToken() {
        (async function () {
            await (async () => {
                const guestIndex = Number(guestSelect.value);
                answerTokens[guestIndex] = answerTokenInput.value;
                const answerTokenWithICE = JSON.parse(answerTokens[guestIndex]);
                await connections[guestIndex].setRemoteDescription(answerTokenWithICE);
                for (let i = 0; i < answerTokenWithICE.ice.length; i++) {
                    if (answerTokenWithICE.ice[i]) {
                        await connections[guestIndex].addIceCandidate(new RTCIceCandidate(answerTokenWithICE.ice[i]));
                    }
                }
            })();
        })();
    }

    function enableOfferTokenInput(isEnable) {
        if (isEnable) {
            if (offerTokenInput.value) {
                offerTokenInput.value = '';
            }
            offerTokenButton.value = '読み込む';
            offerTokenButton.onclick = setAnswerToken;
            offerTokenButton.disabled = '';
            offerTokenInput.disabled = '';
            offerTokenInput.placeholder = 'トークンを貼り付ける';
        } else {
            setOfferToken();
            offerTokenButton.value = 'コピーする';
            offerTokenButton.onclick = function () {
                (async function () {
                    await navigator.clipboard.writeText(offerTokenInput.value);
                })();
            };
            offerTokenInput.disabled = 'disabled';
            offerTokenButton.disabled = '';
            offerTokenInput.placeholder = '';
        }
    }

    function enableAnswerTokenInput(isEnable) {
        if (isEnable) {
            answerTokenButton.value = '読み込む';
            answerTokenButton.onclick = loadAnswerToken;
            answerTokenInput.disabled = '';
            answerTokenButton.disabled = '';
            answerTokenInput.placeholder = '参加トークンを貼り付ける';
        } else {
            answerTokenButton.value = 'コピーする';
            answerTokenButton.onclick = function () {
                (async function () {
                    await navigator.clipboard.writeText(answerTokenInput.value);
                })();
            };
            answerTokenButton.disabled = '';
            answerTokenInput.placeholder = '';
        }
    }

    function addMessageToTable(userName, message) {
        const tr = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.innerText = new Date().toLocaleString();
        tr.appendChild(td1);
        const td2 = document.createElement('td');
        td2.innerText = userName;
        tr.appendChild(td2);
        const td3 = document.createElement('td');
        td3.innerText = message;
        tr.appendChild(td3);
        chatMessagesTbody.appendChild(tr);
    }

    Array.from(document.querySelectorAll('[name=join-type]')).forEach((element) => {
        element.onchange = (event) => {
            const isHost = event.target.value === 'host';
            if (isHost) {
                enableOfferTokenInput(false);
                enableAnswerTokenInput(true);
            } else {
                enableOfferTokenInput(true);
                enableAnswerTokenInput(false);
            }
        }
    });
    document.querySelector('#guest-select').onchange = () => {
        console.log('guest select onchange');
        const joinType = document.querySelector('[name=join-type]:checked');
        if (!joinType) {
            return;
        }
        const isHost = joinType.value === 'host';
        if (isHost) {
            enableOfferTokenInput(false);
            enableAnswerTokenInput(true);
        } else {
            enableOfferTokenInput(true);
            enableAnswerTokenInput(false);
        }
    }</script>
</body>
</html>